<div class="page-header">
  <%= link_to estoques_path, class: 'btn btn-default' do %>
    <span class="glyphicon glyphicon-list-alt"></span>
    Voltar
  <% end %>
  <h1>Ajuste de Estoque</h1>
</div>

<div style="text-align: right;margin-top:10px">
    <form action="/produtos" method="get">
      <div class="row" style="width:300px;display: inline-block;">
        <div style="float: left">
          <input type="text" name="descricao" value="<%=params[:descricao] %>" class="form-control" placeholder="Busca..">
       </div>
       <div style="float: left;margin-left:10px">
          <input type="submit" class="btn btn-primary" value="Buscar">
       </div>
      </div>
    </form>
</div>

<%= form_for(estoques_ajuste_path, html: { class: "form-horizontal", role: "form" }) do |f| %>
  <% if @estoque.errors.any? %>
    <div class="alert alert-danger alert-dismissable" role="alert">
      <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
      <h4>Confira os campos abaixo:</h4>

      <ul>
      <% @estoque.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class="form-group">
    <%= f.label :produto, 'Produto', class: "col-sm-1 control-label" %>
    <div class="col-sm-8">
    <%= f.select :produto_id ,
          Produto.all.collect{|produto| [produto.descricao, produto.id]} , 
          {:selected => @estoque.produto_id, :include_blank => true},
          {:class =>'form-control', :onclick => "buscaProduto()"}
    %>
    </div>
  </div>

  <div class="form-group">
    <%= f.label :lote, 'Lote NÂº', class: "col-sm-1 control-label" %>
    <div class="col-sm-3">
      <%= f.select :id , ["", ""], 
          {:selected => @estoque.lote, :include_blank => true},
          {:class =>'form-control', :onclick => "buscaEstoque()"}
      %>  
    </div>
  </div>

  <div class="form-group">
    <label class="col-sm-1 control-label" for="estoque_inicial">Estoque Inicial</label>
    <div class="col-sm-3">
      <input class="form-control" type="text" id="estoque_inicial" disabled>
    </div>
  </div>

  <div class="form-group">
    <%= f.label :estoque_atual, "Estoque Atual", class: "col-sm-1 control-label" %>
    <div class="col-sm-3">
      <%= f.text_field :estoque_atual, class: "form-control" %>
    </div>
  </div>

  <div class="form-group" style="display: none;">
    <label class="col-sm-1 control-label" for="estoque_id">Id do Estoque</label>
    <div class="col-sm-3">
      <input class="form-control" type="text" name="id" id="id_estoque">
    </div>
  </div>

  <br>

  <div class="form-group">
    <div class="col-sm-2 col-sm-10">
      <%= f.submit "Salvar", class: "btn btn-primary" %>
    </div>
  </div>
<% end %>

<script>
const buscaProduto = () =>{
  const selectElement = document.getElementById("_estoques_ajuste_produto_id")
  var idProduto = selectElement.value

  $.ajax({
    type: "GET",
    url: `/estoques.json?produto_id=${idProduto}.json`,
    success: function(data){
      $("#_estoques_ajuste_id").html("");
      $("#_estoques_ajuste_id").append(`<option value=""></option>`)

      data.forEach(estoque => {
        $("#_estoques_ajuste_id").append(`
          <option value="${estoque.id}">${estoque.lote}</option>
        `)
      });
    }
  })
}

const buscaEstoque = () =>{
  const selectElement = document.getElementById("_estoques_ajuste_id")
  var idEstoque = selectElement.value

  $.ajax({
    type: "GET",
    url: `/estoques/${idEstoque}.json`,
    success: function(data){
      const estoque = data
      $('#id_estoque').val(estoque.id);
      $('#estoque_inicial').val(estoque.estoque_atual);
    }
  })
}
</script>